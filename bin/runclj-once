#!/bin/bash
set -euo pipefail
filepath=$1
root=$(runclj-root $filepath)
now=$(runclj-hash $filepath)
ns=$(runclj-meta $filepath :ns | tr '-' '_')
echo :recompiling >&2
runclj-make-proj $filepath
runclj-update $filepath
if runclj-meta $filepath :browser-mode; then
    cp -f $root/index.html.dev $root/index.html
fi
cd $root
lein cljsbuild once dev
cp -f src/$ns.cljs $ns.cljs
echo "$now" > hash
