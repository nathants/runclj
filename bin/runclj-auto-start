#!/bin/bash
set -euo pipefail
filepath=$1
root=$(runclj-root $filepath)
echo :auto-starting >&2
runclj-make-proj $filepath
runclj-update $filepath
if runclj-meta $filepath :browser-mode; then
    cp -f $root/index.html.dev $root/index.html
fi
cd $root
echo :cljsbuild :auto >&2
echo $$ > runclj-auto.pid
lein trampoline cljsbuild auto dev 2>&1 \
    | tee >(grep --line-buffered "Successfully compiled" > compiled.log) \
    | tee >(cat - > compiler.log)
